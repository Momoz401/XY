{% extends 'layout.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h2>{{ title }}</h2>

    <!-- 筛选表单 -->
    <form method="get" id="filterForm">
        <div class="form-group">
            <label for="category_id">选择二级分类:</label>
            <select name="category_id" id="category_id" class="form-control" onchange="document.getElementById('filterForm').submit();">
                <option value="">全部</option>
                {% for category in available_categories %}
                    <option value="{{ category.id }}" {% if category.id == selected_category %}selected{% endif %}>
                        {{ category.category_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="date_filter">选择时间范围:</label>
            <select name="date_filter" id="date_filter" class="form-control" onchange="document.getElementById('filterForm').submit();">
                <option value="week" {% if date_filter == 'week' %}selected{% endif %}>最近一周</option>
                <option value="month" {% if date_filter == 'month' %}selected{% endif %}>最近一个月</option>
                <option value="year" {% if date_filter == 'year' %}selected{% endif %}>最近一年</option>
            </select>
        </div>
    </form>

    <!-- 图表显示部分 -->
    <canvas id="priceChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('priceChart').getContext('2d');
    var marketData = {{ market_data|safe }};
    var datasets = [];

    for (var marketName in marketData) {
        var dates = marketData[marketName].dates;
        var prices = marketData[marketName].prices;

        datasets.push({
            label: marketName,
            data: prices,
            borderColor: getRandomColor(),
            fill: false,
            tension: 0.1
        });
    }

    var priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: marketData[Object.keys(marketData)[0]].dates,
            datasets: datasets
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '日期'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '价格'
                    }
                }
            }
        }
    });

    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
</script>
{% endblock %}