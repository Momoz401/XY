{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">添加出库记录</h3>
        </div>
        <div class="panel-body">
            <form method="post" id="desktop_outbound_form" novalidate>
                {% csrf_token %}

                <!-- 日期 默认今天 -->
                <div class="form-group">
                    <label for="id_日期">日期</label>
                    <!-- value="{{ today }}" 可以使输入框默认显示今天的日期 -->
                    <input type="date" name="日期" id="id_日期" class="form-control" value="{{ today }}">
                </div>

                <!-- 车牌 -->
                <div class="form-group">
                    <label for="id_车牌">车牌</label>
                    <select name="车牌" id="id_车牌" class="form-control">
                        <option value="">请选择车牌</option>
                        {% for vehicle in vehicles %}
                            <option value="{{ vehicle.车牌 }}">{{ vehicle.车牌 }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 公司（手动输入） -->
                <div class="form-group">
                    <label for="id_公司">公司</label>
                    <input type="text" name="公司" id="id_公司" class="form-control" autocomplete="off">
                </div>

                <!-- 市场（下拉） -->
                <div class="form-group">
                    <label for="id_市场">市场</label>
                    <select name="市场" id="id_市场" class="form-control">
                        <option value="">请选择市场</option>
                        {% for market in markets %}
                            <option value="{{ market.市场名称 }}">{{ market.市场名称 }}</option>
                        {% empty %}
                            <option value="">无市场数据</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 规格（手动输入） -->
                <div class="form-group">
                    <label for="id_规格">规格</label>
                    <input type="text" name="规格" id="id_规格" class="form-control" autocomplete="off">
                </div>

                <!-- 单位 -->
                <div class="form-group">
                    <label for="id_单位">单位</label>
                    <select name="单位" id="id_单位" class="form-control">
                        <option value="kg">kg</option>
                        <option value="吨">吨</option>
                        <option value="斤">斤</option>
                    </select>
                </div>

                <!-- 数量_筐 -->
                <div class="form-group">
                    <label for="id_数量_筐">数量(筐)</label>
                    <input type="number" name="数量_筐" id="id_数量_筐" class="form-control" step="1">
                </div>

                <!-- 重量_kg -->
                <div class="form-group">
                    <label for="id_重量_kg">重量(kg)</label>
                    <input type="number" name="重量_kg" id="id_重量_kg" class="form-control" step="0.01">
                </div>

                <!-- 批次(自动补全) -->
                <div class="form-group">
                    <label for="id_批次">批次</label>
                    <input type="text" name="批次" id="id_批次" class="form-control" autocomplete="off">
                </div>

                <!-- 地块(随批次刷新) -->
                <div class="form-group">
                    <label for="id_地块">地块</label>
                    <select name="地块" id="id_地块" class="form-control">
                        <option value="">请选择地块</option>
                    </select>
                </div>

                <!-- 盖布_块 -->
                <div class="form-group">
                    <label for="id_盖布_块">盖布(块)</label>
                    <input type="number" name="盖布_块" id="id_盖布_块" class="form-control" step="1">
                </div>

                <!-- 备注 -->
                <div class="form-group">
                    <label for="id_备注">备注</label>
                    <textarea name="备注" id="id_备注" class="form-control" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">提交</button>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script>
$(function(){
    // 批次自动补全
    $('#id_批次').autocomplete({
        source: function(request, response){
            $.ajax({
                url: "{% url 'batch_autocomplete' %}",
                dataType: "json",
                data: { term: request.term },
                success: function(data){
                    response(data);
                }
            });
        },
        minLength: 1,
        select: function(event, ui){
            refreshPlot(ui.item.value);
        }
    });

    // 批次输入 -> 刷新地块
    $('#id_批次').on('input', function(){
        const val = $(this).val();
        if (val.length >= 1) {
            refreshPlot(val);
        } else {
            $('#id_地块').empty().append($('<option>').val('').text('请选择地块'));
        }
    });

    // 地块刷新函数
    function refreshPlot(batchVal){
        $.ajax({
            url: "{% url 'get_Plant_batch_dk' %}",
            type: "GET",
            data: { one: batchVal },
            success: function(res){
                let $plot = $('#id_地块');
                $plot.empty().append($('<option>').val('').text('请选择地块'));

                // 如果后端返回字典 => { "B13-B23":"B13-B23", ... }
                const keys = Object.keys(res);
                if (keys.length === 0) return;
                keys.forEach(function(key){
                    const val = res[key];
                    $plot.append($('<option>').val(key).text(val));
                });
                // 若只有一条 -> 自动选中
                if (keys.length === 1) {
                    $plot.val(keys[0]);
                }
            }
        });
    }
});
</script>
{% endblock js %}